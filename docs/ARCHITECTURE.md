# WorkforceCalc (HRPlan) Architecture & Development Guide

このドキュメントは、WorkforceCalc (旧 OCalc) プラグインの内部設計思想、技術スタック、および**改修時に絶対に守るべき制約事項**をまとめています。
人間のコントリビューター、およびコードを編集するAIアシスタントは、コードを変更する前に必ずこのドキュメントを熟読し、既存の設計意図を破壊しないように注意してください。

## 1. プロジェクトの設計思想 (Philosophy)
WorkforceCalcは、Obsidian内で要員計画（HRPlan）を管理するための軽量なスプレッドシートを実現するカスタムプラグインです。
最大の特徴は「プレーンテキストのポータビリティ」です。独自バイナリや複雑なJSONではなく、`.hrplan` というハイブリッド拡張子（YAML Frontmatter + CSV）を採用しています。
これにより、ユーザーにとっての直感的な操作性と、LLM（AI）や外部スクリプトからのパース・書き換えの容易さを両立しています。

## 2. 技術スタック
* **UI描画**: Vanilla JS (Obsidian標準の `createEl`, `createDiv` 等のDOM APIを使用。ReactやVueなどの外部フレームワークは不使用)
* **CSVパース**: `papaparse`
* **数値計算**: `mathjs`

## 3. ファイルフォーマット (.hrplan)
ファイルは大きく2つのセクションに分かれています。
1. **YAML Frontmatter**: 期間 (`period`)、対象月 (`months`)、マスタ情報 (`themes`, `members`)、および計算済みの小計 (`memberTotals`, `themeTotals`) などのメタデータと集計結果を保持します。
2. **CSV Body**: メンバ別・テーマ別の月別アサイン工数（MM）データのみを純粋なマトリクスとして保持します。ここで計算式や合計値自体は持たせません。

## 4. ⚠️ 開発上の絶対ルールとハック（Do Not Modify）
以下の実装は、一見すると「冗長」や「無駄」に見えるかもしれませんが、致命的なバグを回避するための意図的な設計です。**リファクタリング等の名目で絶対に削除・改変しないでください。**

### 4.1. PapaParseの空行スキップ設定 (`skipEmptyLines: false`)
* **理由:** `skipEmptyLines: true` に設定すると、データが空になった際、「完全にデータが0件」とパースされてしまい、保存時にファイルが破損するリスクがあります。
* **現在の実装:** `false` に設定し、パース結果のデータが0件の場合は空配列として扱う保護ロジックを持たせています。

### 4.2. 浮動小数点の丸め込みハック (`precision: 14`)
* **理由:** JavaScriptのIEEE 754問題により、工数の足し算（例: `0.1 + 0.2 = 0.30000000000000004`）において微小な誤差が発生するのを防ぐためです。
* **現在の実装:** `MyCalcView.ts` において、以下の箇所で数値を必ず14桁精度でフォーマットしてから `Number()` にキャストしています。
  * `saveData` 内（小計の計算時）
  * テーブル描画内（行合計および月ごと小計の計算表示時）
  * 例: `Number(math.format(sum, { precision: 14 }))`

### 4.3. 小計データ (SubTotals) の分離（Frontmatterへの保存）
* **理由:** CSV内に「小計」という文字や数値をインバンドで含めると、LLMがデータ行と合計行を混同する原因になります。アサイン工数の集計ピボットはCSVボディの外側で管理されるべきです。
* **現在の実装:** 保存時（`saveData`）に「メンバ別」「テーマ別」の小計を計算して、それぞれ `frontmatter.memberTotals` と `frontmatter.themeTotals` にメタデータとして書き込みます。画面描画時（`renderUI`）は、データから表を動的生成し、計算結果は表示用としてのみ導出します。総合計 (Grand Totals) は使わず、マトリクスによる集計のみとします。

### 4.4. 表示用の状態管理 (Collapsed State)
* **理由:** ピボットテーブルにて、特定のメンバ・テーマの行や、月別の列（期間）を折りたためるUI要件を満たすためです。
* **現在の実装:** プラグインのViewインスタンス（`HRPlanView`）に `collapsedRows` (Set<string>) および `isMonthsCollapsed` (boolean) という状態を持たせ、`renderUI` 時に対象要素を描画するかどうかを制御しています。状態変更時は `this.renderUI()` で再描画するシンプルなリアクティブアーキテクチャを取っています。

### 4.5. マスタデータの連動とデータ破壊防止
* **理由:** マスタータブでメンバやテーマの「名前」を変更した際、CSVデータ側の「Member」「Theme」列が古い名前のままだと、キーが不一致となりデータが消失（または迷子に）なります。
* **現在の実装:** 名前変更イベント (`onblur`) 発火時に、CSVデータの全レコードを走査し、対象の旧名を持つレコードのキーをすべて新名に書き換えてから保存（`saveData`）しています。