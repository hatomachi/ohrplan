# OCalc Spreadsheet Architecture & Development Guide

このドキュメントは、OCalc Spreadsheetの内部設計思想、技術スタック、および**改修時に絶対に守るべき制約事項**をまとめています。
人間のコントリビューター、およびコードを編集するAIアシスタントは、コードを変更する前に必ずこのドキュメントを熟読し、既存の設計意図を破壊しないように注意してください。

## 1. プロジェクトの設計思想 (Philosophy)
OCalcは、Obsidian内で軽量なスプレッドシートを実現するカスタムプラグインです。
最大の特徴は「プレーンテキストのポータビリティ」です。独自バイナリや複雑なJSONではなく、`.ocalc` というハイブリッド拡張子（YAML Frontmatter + CSV）を採用しています。
これにより、ユーザーにとっての直感的な操作性と、LLM（AI）や外部スクリプトからのパース・書き換えの容易さを両立しています。

## 2. 技術スタック
* **UI描画**: Vanilla JS (Obsidian標準の `createEl`, `createDiv` 等のDOM APIを使用。ReactやVueなどの外部フレームワークは不使用)
* **CSVパース**: `papaparse`
* **数式エンジン**: `mathjs`

## 3. ファイルフォーマット (.ocalc)
ファイルは大きく2つのセクションに分かれています。
1. **YAML Frontmatter**: 計算式 (`formulas`) や、合計行の設定と**計算済み結果** (`totals.results`) などのメタデータを保持します。
2. **CSV Body**: 純粋な行データのみを保持します。合計行や計算式自体はここには含まれません。

## 4. ⚠️ 開発上の絶対ルールとハック（Do Not Modify）
以下の実装は、一見すると「冗長」や「無駄」に見えるかもしれませんが、致命的なバグを回避するための意図的な設計です。**リファクタリング等の名目で絶対に削除・改変しないでください。**

### 4.1. PapaParseの空行スキップ設定 (`skipEmptyLines: false`)
* **理由:** `skipEmptyLines: true` に設定すると、1列しかない表でユーザーがデータを空にした際、「完全にデータが0件」とパースされてしまい、保存時に行ごとファイルから消滅するバグが発生します。
* **現在の実装:** `false` に設定し、パース結果のデータが0件になった場合は、手動で空の1行オブジェクトを生成・補填する保護ロジックを実装しています。

### 4.2. 浮動小数点の丸め込みハック (`precision: 14`)
* **理由:** JavaScriptのIEEE 754問題により、計算列や合計値の足し算において `113.32000000000001` のような微小な誤差が発生するのを防ぐためです。
* **現在の実装:** `MyCalcView.ts` において、以下の2箇所で数値を必ず14桁精度でフォーマットしてから `Number()` にキャストしています。
  * `evaluateFormula` 内（各行の計算時）
  * `saveData` 内（合計値の計算時）
  * 例: `Number(math.format(value, { precision: 14 }))`

### 4.3. 合計行データの分離（Frontmatter `results` への保存）
* **理由:** CSVの最終行に「合計」という文字や数値をインバンドで含めると、LLMがデータ行と合計行を混同する原因になります。また、行のドラッグ＆ドロップ実装時に「合計行をソート対象から除外する例外処理」が大量に必要になり、コードが脆くなります。
* **現在の実装:** 保存時（`saveData`）に合計値を計算して `frontmatter.totals.results` にメタデータとして書き込みます。画面描画時（`renderUI`）は、CSVのデータはそのまま描画し、フッター（`tfoot`）の数値はFrontmatterから読み取って表示するだけの完全分離設計としています。

### 4.4. 埋め込み表示プロセッサーの選定
* **理由:** 当初、Markdown内の `![[ファイル名]]` をフックするために `registerMarkdownPostProcessor` を使用しましたが、Live PreviewモードのCodeMirror 6にインターセプトされて正常に描画されませんでした。
* **現在の実装:** Obsidian公式のベストプラクティスに則り、`registerMarkdownCodeBlockProcessor` を使用して ` ```ocalc ` コードブロックでの埋め込み表示を実装しています。